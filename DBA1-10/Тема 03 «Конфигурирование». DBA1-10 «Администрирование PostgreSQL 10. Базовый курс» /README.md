# Конфигурирование

## Параметры
* Задача
  * управление работой и поведением СУБД
* Установка 
  * для экземпляра — файлы конфигурации
  * для отдельной базы или пользователя
  * для отдельного сеанса

В PostgreSQL существует большое количество параметров, влияющих на
работу СУБД. Параметры позволяют управлять потреблением ресурсов,
настраивать работу серверных процессов и многое другое.
Например, при помощи параметра max_connections можно ограничить
количество одновременных подключений к серверу.
Полный список и описание параметров конфигурации:
https://postgrespro.ru/docs/postgresql/10/runtime-config.html
В этой теме мы не изучаем назначение отдельных параметров
конфигурации, а лишь рассматриваем какими способами им можно
устанавливать значения.
Для установки параметров, в первую очередь, используются файлы
конфигурации. Если не определено иное, значения установленные в этих
файлах действуют для всего экземпляра СУБД.
Ряд параметров можно установить для отдельной базы данных или
пользователя. Такие установки будут иметь предпочтение перед файлами
конфигурации. Мы подробнее коснёмся этого варианта в следующих темах
курса.
Наконец, многими параметрами можно управлять на уровне отдельного
сеанса, прямо во время работы

## postgresql.conf

* Основной файл конфигурации
  * читается один раз при старте сервера
  * если параметр указан несколько раз, применяется последнее значение
* Расположение
  * SHOW config_file;
  * при сборке по умолчанию — в каталоге с данными (PGDATA)
* Действия при изменении
  * файл надо перечитать одним из способов:
  * `$ pg_ctl reload`
  * `$ kill -HUP`
  * `=> select pg_reload_conf();`
* изменения некоторых параметров требует перезапуска сервера

Основной конфигурационный файл — `postgresql.conf`.
Расположение файла задается при сборке PostgreSQL. Значение по
умолчанию — каталог с данными `(PGDATA)`, но пакетные дистрибутивы
обычно размещают этот файл в другом месте, в соответствии с правилами
принятыми в конкретной ОС.
Это текстовый, хорошо документированный, файл, хранящий параметры в
формате `«ключ=значение»`.
Если один и тот же параметр указан в конфигурационном файле (файлах)
несколько раз, то использоваться будет значение считанное последним.
Для вступления в силу внесенных в файл изменений, необходимо, чтобы
сервер перечитал файл. Для некоторых параметров требуется перезагрузка
сервера.

## postgresql.auto.conf

* Файл конфигурации, управляемый SQL
  * `ALTER SYSTEM SET параметр TO значение;` - добавляет или изменяет строку
  * `ALTER SYSTEM RESET параметр;` - удаляет строку
  * `ALTER SYSTEM RESET ALL;` - удаляет все строки
  * **считывается после `postgresql.conf`**
* Расположение
  * всегда в каталоге с данными (PGDATA)
* Действия при изменении
  * аналогично postgresql.conf

Самым последним считывается файл `postgresql.auto.conf`. Этот файл всегда
располагается в каталоге данных (`PGDATA`).
Этот файл не следует изменять вручную. Для его редактирования
предназначена команда `ALTER SYSTEM`. По сути `ALTER SYSTEM`
представляет собой SQL-интерфейс для удаленного управления
параметрами конфигурации.
Для применения изменений, сделанных `ALTER SYSTEM`, сервер должен
перечитать конфигурационные файлы, как и в случае с `postgresql.conf`.
Содержимое обоих файлов (`postgresql.conf` и `postgresql.auto.conf`) можно
увидеть через представление `pg_file_settings`.
А актуальные значения параметров — в представлении `pg_settings`.
Более подробная информация о команде `ALTER SYSTEM`:
https://postgrespro.ru/docs/postgresql/10/sql-altersystem.htm

## Практика

### Файл postgresql.conf и предаставление PG_FILE_SETTINGS
```shell
# Посмотрим небольшой фрагмент конфигурационного файла.

=> SELECT setting FROM pg_settings WHERE name = 'config_file';     
                setting                
---------------------------------------
 /usr/local/pgsql/data/postgresql.conf
(1 row)

=> \! sed -n '35,46p' /usr/local/pgsql/data/postgresql.conf 
#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------

# The default values of these variables are driven from the -D command-line
# option or PGDATA environment variable, represented here as ConfigDir.

#data_directory = 'ConfigDir'		# use data in another directory
					# (change requires restart)
#hba_file = 'ConfigDir/pg_hba.conf'	# host-based authentication file
					# (change requires restart)
#ident_file = 'ConfigDir/pg_ident.conf'	# ident configuration file

# Большинство строк в файле закомментированы, а для соответсвующих параметров 
# используются значения по умолчанию.
```

### Просмотр незадокументированых строк
```shell
# Чтобы увидеть все незакоментированные строки конфигурационного файла, можно
# обратится к представлению pg_file_settings:

=> SELECT sourceline, name, setting, applied FROM pg_file_settings WHERE sourcefile LIKE '%postgresql.conf%'; 
 sourceline |            name            |      setting       | applied 
------------+----------------------------+--------------------+---------
         65 | max_connections            | 100                | t
        127 | shared_buffers             | 128MB              | t
        150 | dynamic_shared_memory_type | posix              | t
        240 | max_wal_size               | 1GB                | t
        241 | min_wal_size               | 80MB               | t
        580 | log_timezone               | Europe/Moscow      | t
        694 | datestyle                  | iso, dmy           | t
        696 | timezone                   | Europe/Moscow      | t
        710 | lc_messages                | ru_RU.UTF-8        | t
        712 | lc_monetary                | ru_RU.UTF-8        | t
        713 | lc_numeric                 | ru_RU.UTF-8        | t
        714 | lc_time                    | ru_RU.UTF-8        | t
        717 | default_text_search_config | pg_catalog.russian | t
(13 rows)

# Столбец applied говорит о том, можно ли применить значение без перезапуска сервера. 
# Представление pg_file_settings показывает лишь содержимое файлов конфигурации,
# поэтому реальные значения параметров могут отличаться.
```

### Представление pg_settings
```shell
# Получить действующее значение 
```

### TITLE
```shell

```

### TITLE
```shell

```

### TITLE
```shell

```

### TITLE
```shell

```

### TITLE
```shell

```