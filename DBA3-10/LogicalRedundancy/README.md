### Логическая копия

Команды SQL для создания объектов и наполнения данными

- Плюсы 
  - можно сделать копию отдельного объекта или отдельной базы 
  - можно восстановиться на другой версии или архитектуре
  - (не требуется двоичная совместимость)
 

- Минусы 
  - невысокая скорость работы
  - восстановление только на момент создания резервной копии

Логическое резервирование — набор команд SQL, восстанавливающих
кластер (или базу данных, или отдельную таблицу) с нуля: создаются
необходимые объекты и наполняются данными.


Команды можно выполнить на другой версии СУБД (при наличии
совместимости на уровне команд) или на другой платформе и
архитектуре (не требуется двоичная совместимость).


В частности, логическую резервную копию можно использовать для
долговременного хранения: ее можно будет восстановить и после
обновления сервера на новую версию.
Однако для большой базы команды могут выполняться очень долго.
Восстановить систему из логической копии можно ровно на момент
начала резервного копирования

***

### Копия таблицы

- Серверный вариант: SQL-команда `COPY`
- Клиентский вариант: команда `psql \copy`

*** 

### SQL-команда `COPY`
<img src="https://github.com/v1adt3r/SQL/blob/main/DBA3-10/LogicalRedundancy/1.jpeg?raw=true"></img>

- Файл в ФС сервера и доступен владельцу экземпляра PostgreSQL, можно ограничить столбцы (или использовать произвольный запрос)
при восстановлении строки добавляются к имеющимся в таблице
  

- Если требуется сохранить только содержимое одной таблицы, можно
воспользоваться командой `COPY`.
***Команда позволяет записать таблицу (или часть столбцов таблицы, или
даже результат произвольного запроса) либо в файл, либо на консоль,
либо на вход какой-либо программе.*** При этом можно указать ряд
параметров, таких как ***формат*** (`текстовый`, `CSV` или `двоичный`),
***разделитель полей***, ***текстовое представление*** ***NULL*** и т. п.
Другой вариант команды, наоборот, считывает из файла или из консоли
строки с полями и записывает их в таблицу. Таблица при этом не
очищается, новые строки добавляются к уже существующим.
Команда `COPY` работает существенно быстрее, чем аналогичные
команды `INSERT` — клиенту не нужно много раз обращаться к серверу,
а серверу не нужно много раз анализировать команды.
  

- Тонкость: при выполнении команды `COPY FROM` не применяются
правила (rules), хотя ограничения целостности и триггеры выполняются.
  
***

### Команда psql `\copy`

<img src="https://github.com/v1adt3r/SQL/blob/main/DBA3-10/LogicalRedundancy/2.jpeg?raw=true"></img>

- Файл в ФС клиента и доступен пользователю ОС, запустившему psql
  происходит пересылка данных между клиентом и сервером
  синтаксис и возможности аналогичны команде COPY


- В psql существует клиентский вариант команды `COPY` с аналогичным
  синтаксисом.
  В отличие от серверного варианта `COPY`, который является командой
  SQL, клиентский вариант — это команда `psql`. Указание имени файла в команде SQL соответствует файлу на сервере БД. 
  У пользователя, под которым работает PostgreSQL (обычно postgres), должен быть доступ к этому файлу.
  В клиентском же варианте обращение к файлу происходит на клиенте,
  а на сервер передается только содержимое.

***

### Копия базы данных

- Утилита pg_dump
- Возможные форматы выгрузки

***

### Копия базы данных
<img src="https://github.com/v1adt3r/SQL/blob/main/DBA3-10/LogicalRedundancy/3.jpeg?raw=true"></img>

- Формат: команды SQL
  при выгрузке можно выбрать отдельные объекты базы данных
  новая база должна быть создана из шаблона template0
  заранее должны быть созданы роли и табличные пространства
  после загрузки имеет смысл выполнить ANALYZE


- Для создания полноценной резервной копии базы данных используется
утилита pg_dump.
  

- Если не указать имя файла (-f, --file), то утилита выведет результат на
консоль. А результатом является скрипт, предназначенный для psql,
который содержит команды для создания необходимых объектов и
наполнения их данными.

  
- Дополнительными ключами утилиты можно ограничить набор объектов:
выбрать указанные таблицы, или все объекты в указанных схемах, или
наложить другие фильтры.
  

- Чтобы восстановить объекты из резервной копии, достаточно
выполнить полученный скрипт в psql.


- Следует иметь в виду, что базу данных для восстановления надо
создавать из шаблона template0, так как все изменения, сделанные в
template1, также попадут в резервную копию.


- Кроме того, заранее должны быть созданы необходимые роли и
табличные пространства. Поскольку эти объекты не относятся к
конкретной БД, они не будет выгружены в резервную копию.


- После восстановления базы имеет смысл выполнить команду
ANALYZE: она соберет статистику, необходимую оптимизатору для
планирования запросов.

***

### Формат custom
<img src="https://i.ibb.co/M2h3VHn/3.jpg"></img>

- внутренний формат с оглавлением отдельные объекты базы данных можно выбрать на этапе восстановления
  возможна загрузка в несколько параллельных потоков
  

- Утилита pg_dump позволяет указать формат резервной копии. По умолчанию это plain — простые команды для psql.


- Формат custom `(-F c, --format=custom)` создает резервную копию в
специальном формате, содержащем не только объекты, но и
оглавление. Наличие оглавления позволяет выбирать объекты для
восстановления не при создании копии, а непосредственно при
восстановлении.


- Файл формата custom по умолчанию сжат.


- Для восстановления потребуется другая утилита — `pg_restore`. Она
читает файл и преобразует его в команды psql. Если не указать явно
имя базы данных (в ключе `-d`), то команды будут выведены на консоль.


- Если же база данных указана — утилита соединится с этой БД и
выполнит команды без участия psql.


- Чтобы восстановить только часть объектов, можно воспользоваться
одним из двух подходов. Во-первых, можно ограничить объекты
аналогично тому, как они ограничиваются в `pg_dump`. Вообще, утилита
`pg_restore` понимает многие параметры из репертуара `pg_dump`.


- Во-вторых, можно получить из оглавления список объектов,
содержащихся в резервной копии (ключ `--list`). Затем этот список можно
отредактировать вручную, удалив ненужное и передать измененный
список на вход pg_restore (ключ --use-list).
*** 

### Формат directory
<img src="https://i.ibb.co/y01JBxV/4.jpg"></img>

-

*** 

### Сравнение форматов